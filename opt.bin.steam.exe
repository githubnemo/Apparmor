# Last Modified: Tue Dec  2 20:08:38 2014
#include <tunables/global>

#/usr/bin/steam flags=(audit) {
/opt/bin/steam.exe {
  #include <abstractions/X>
  #include <abstractions/audio>
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/dbus-session>
  #include <abstractions/fonts>
  #include <abstractions/freedesktop.org>
  #include <abstractions/nameservice>
  #include <abstractions/nvidia>
  #include <abstractions/p11-kit>
  #include <abstractions/user-tmp>
  #include <abstractions/fonts>
  #include <abstractions/dbus-strict>
  #include <abstractions/private-files-strict>

  ptrace peer=/opt/bin/steam.exe,

  deny /proc/scsi/scsi r,

  # necessary for writing to sockets, etc.
  owner /dev/shm/** rmw,
  /{,var/}run/** rmkix,
  /{,var/}run/shm/** wl,
  /{,var/}run/uuidd/request w,

  / r,
  /bin/* rix,
  /etc/fstab r,
  /etc/gtk-3.0/* r,
  /etc/lsb-release r,
  /etc/magic r,
  /etc/wgetrc r,
  /etc/ld.so.preload r,

  owner @{HOME}/ r,
  owner @{HOME}/bin/** rix,
  owner @{HOME}/.config/gtk-3.0/** r,
  owner @{HOME}/.local/share/Steam/ r,
  owner @{HOME}/.local/share/Steam/** mrwkixl,
  owner @{HOME}/.steampid rw,
  owner @{HOME}/.steampath rw,
  owner @{HOME}/.steam/** mrwkix,
  owner @{HOME}/.nv/* mrwk,
  owner @{HOME}/.nv/** mrwk,
  owner @{HOME}/.nv/**/ mrwk,
  owner @{HOME}/.cache/fontconfig/* rw,
  owner @{HOME}/.cache/wine/** rw,
  owner @{HOME}/@{XDG_DESKTOP_DIR}/ r,

  # Don't Starve
  owner @{HOME}/.klei/** mrwixkl,

  # Endless Space
  owner "@{HOME}/Endless Space/" rw,
  owner "@{HOME}/Endless Space/**" mrwl,

  /mnt/ r,
  /media/*{,/} r,
  owner /media/*/** rml,
  owner /media/*/**/SteamLibrary/** rwkix,

  /proc/@{pid}/auxv r,
  /proc/*/fd/ r,
  /proc/*/mem rw,
  /proc/*/status r,
  /proc/*/stat r,
  /proc/*/task/ r,
  /proc/driver/nvidia/* r,
  /proc/modules r,
  /proc/version r,

  /run/cups/printcap r,

  /sys/bus/pci/devices r,
  /sys/bus/pci/devices/ r,
  /sys/devices/system/cpu/** r,
  /sys/devices/system/node/** r,
  /sys/devices/pci*/**/uevent r,
  /sys/devices/platform/**/uevent r,
  /sys/devices/pci*/**/{busnum,idvendor,idproduct,resource,irq} r,
  /sys/devices/pci*/**/{vendor,device,class} r,
  /sys/devices/system/clocksource/*/current_clocksource r,

  /tmp/** mrwlk,
  /tmp/w.*/ mrwk,
  /tmp/w.*/* mrwk,
  /tmp/w.*/** mrwk,
  /tmp/w.*/**/ mrwk,
  /tmp/w.*/*/ mrwk,

  /usr/ r,
  /usr/bin/* rix,
  /usr/lib/ r,
  /usr/lib{,32,64}/** mr,
  /usr/bin/steam r,
  /usr/share/file/magic.mgc r,
  /usr/share/file/magic/ r,
  /usr/share/fonts/** r,
  /usr/share/nvidia-*/* r,
  /usr/share/themes/** r,
  /usr/share/zenity/* r,
  /opt/wine-staging/** rix,

  # wine
  owner @{HOME}/.wine/ r,
  owner @{HOME}/.wine/** rixwlk,

  unix (bind, listen) type=stream,

  owner @{HOME}/.local/share/icons/** rwl,

	# [131656.696179] audit: type=1107 audit(1429736900.307:23834024): pid=735 uid=102 auid=4294967295 ses=4294967295 msg='apparmor="DENIED" operation="dbus_method_call"  bus="system" path="/org/freedesktop/RealtimeKit1" interface="org.freedesktop.RealtimeKit1" member="MakeThreadRealtimeWithPID" mask="send" name="org.freedesktop.RealtimeKit1" pid=9078 profile="/opt/bin/steam.exe" peer_pid=2829 peer_profile="unconfined"
  dbus (receive, send) bus=system,

  /usr/share/wine/** rixk,
}

